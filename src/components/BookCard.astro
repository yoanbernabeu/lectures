---
import { slugify } from '../utils/slugify';

interface Props {
  book: {
    id: string;
    googleBooksId: string;
    status: 'reading' | 'finished' | 'to-read';
    progress?: number;
    startDate?: string;
    endDate?: string;
    rating?: number | null;
    comment?: string | null;
    abandoned?: boolean;
    genres?: string[];
    favorite?: boolean;
  };
  googleData?: {
    title: string;
    authors?: string[];
    description?: string;
    imageLinks?: {
      thumbnail: string;
    };
  };
  compact?: boolean;
}

const { book, googleData, compact = false } = Astro.props;

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const getStatusBadgeClass = (status: string) => {
  const baseClasses = "text-sm px-3 py-1 rounded-full font-medium";
  switch (status) {
    case 'reading':
      return `${baseClasses} bg-primary/20 text-primary border border-primary/30`;
    case 'finished':
      return `${baseClasses} bg-green-500/20 text-green-400 border border-green-500/30`;
    case 'to-read':
      return `${baseClasses} bg-dark-lighter text-gray-300 border border-gray-600`;
    default:
      return baseClasses;
  }
};

const getStatusLabel = (status: string) => {
  switch (status) {
    case 'reading': return 'En cours';
    case 'finished': return 'Terminé';
    case 'to-read': return 'À lire';
    default: return status;
  }
};
---

<div class="card bg-base-200 shadow-xl h-full hover:shadow-2xl transition-all duration-300">
  <a href={`/book/${book.id}`} class="h-full flex flex-col">
    <figure class="relative w-full">
      <div 
        class="w-full"
        x-data="{ loaded: false }"
      >
        {googleData?.imageLinks?.thumbnail ? (
          <div class="relative aspect-[2/3]">
            <div class="skeleton absolute inset-0" :class="loaded ? 'opacity-0' : 'opacity-100'"></div>
            <img
              src={googleData.imageLinks.thumbnail}
              alt={`Couverture du livre ${googleData.title}`}
              class="w-full h-full object-cover transition-opacity duration-300 absolute inset-0"
              loading="lazy"
              decoding="async"
              x-ref="image"
              @load="loaded = true"
              :class="loaded ? 'opacity-100' : 'opacity-0'"
            />
          </div>
        ) : (
          <div class="aspect-[2/3] bg-base-300 flex items-center justify-center">
            <svg class="w-12 h-12 text-base-content/20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
            </svg>
          </div>
        )}
      </div>
      <div class="absolute top-2 left-2 flex gap-1 flex-wrap max-w-[calc(100%-1rem)]">
        <span class="badge badge-primary">{getStatusLabel(book.status)}</span>
        {book.abandoned && <span class="badge badge-error">Abandonné</span>}
        {book.favorite && (
          <span class="badge badge-secondary">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Coup de cœur
          </span>
        )}
      </div>
    </figure>
    
    <div class="card-body p-4">
      <h2 class="card-title text-base line-clamp-2">
        {googleData?.title || 'Titre inconnu'}
      </h2>
      
      {googleData?.authors && (
        <p class="text-sm opacity-70 line-clamp-1">
          par {googleData.authors.join(', ')}
        </p>
      )}

      {book.status === 'reading' && book.progress && (
        <div class="mt-2">
          <progress 
            class="progress progress-primary w-full" 
            value={book.progress} 
            max="100"
          ></progress>
          <p class="text-xs opacity-70 mt-1">{book.progress}% lu</p>
        </div>
      )}

      {book.rating && (
        <div class="rating rating-sm mt-2">
          {[...Array(5)].map((_, i) => (
            <input
              type="radio"
              class="mask mask-star-2 bg-primary"
              disabled
              checked={i + 1 === book.rating}
            />
          ))}
        </div>
      )}
    </div>
  </a>
</div>

<style>
  .skeleton {
    background: linear-gradient(
      90deg,
      var(--b3, hsl(var(--b3))) 25%,
      var(--b2, hsl(var(--b2))) 37%,
      var(--b3, hsl(var(--b3))) 63%
    );
    background-size: 400% 100%;
    animation: skeleton 1.4s ease infinite;
  }

  @keyframes skeleton {
    0% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0 50%;
    }
  }
</style> 